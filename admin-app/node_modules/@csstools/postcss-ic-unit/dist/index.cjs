"use strict";

const { postcssPlugin } = require("postcss");
const progressiveCustomProperties = require("@csstools/postcss-progressive-custom-properties");
const postcssValueParser = require("postcss-value-parser");

const convertICToEM = (options = {}) => {
  const { preserve = false, enableProgressiveCustomProperties = true } = options;

  const convertIC = (decl) => {
    if (!decl.value.toLowerCase().includes("ic")) return;

    const parsedValue = postcssValueParser(decl.value);
    parsedValue.walk((node) => {
      if (!node.type || node.type !== "word") return;
      const unit = postcssValueParser.unit(node.value);
      if (unit && unit.unit.toLowerCase() === "ic") {
        node.value = `${unit.number}em`;
      }
    });

    const newValue = parsedValue.toString();
    if (newValue !== decl.value) {
      decl.cloneBefore({ value: newValue });
      if (!preserve) decl.remove();
    }
  };

  return postcssPlugin("postcss-ic-unit", () => ({
    Declaration(decl) {
      if (!enableProgressiveCustomProperties) return;
      convertIC(decl);
    },
  }));
};

module.exports = convertICToEM;

